<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa Universidad del Quindío</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
body { margin:0; font-family: sans-serif; }
#map { width:100vw; height:100vh; }

/* ===== Panel destinos ===== */
#panel {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255,255,255,0.95);
  padding: 12px 15px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  z-index: 10;
  width: 230px;
}

#panel h3 { margin: 0 0 6px 0; font-size: 14px; }
#infoRuta { font-size: 12px; margin-bottom: 8px; }

#panel ul { list-style: none; padding: 0; margin: 0; }

#panel li {
  padding: 6px 10px;
  margin: 4px 0;
  background: #0055ff;
  color: white;
  border-radius: 5px;
  cursor: pointer;
  font-size: 13px;
}

#panel li:hover { background: #003bb3; }

/* ===== Panel edificio ===== */
#panelEdificio {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 320px;
  background: rgba(255,255,255,0.96);
  padding: 14px;
  border-radius: 12px;
  box-shadow: 0 5px 18px rgba(0,0,0,0.25);
  z-index: 10;
}

/* ===== Botón navegación ===== */
.btn-navegar {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #0066ff;
  color: white;
  border: none;
  padding: 12px 18px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 20;
}

.oculto { display: none; }

.marker-usuario {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: red;
  box-shadow: 0 0 10px rgba(255,0,0,0.8);
  border: 2px solid white;
}

/* ===== Galería ===== */
.galeria {
  display: flex;
  gap: 6px;
  margin-top: 6px;
  flex-wrap: wrap;
}

.galeria img {
  width: 64px;
  height: 48px;
  object-fit: cover;
  border-radius: 4px;
}

/* ===== MÓVIL ===== */
@media (max-width: 768px) {
  #panel {
    width: calc(100% - 20px);
    left: 10px;
    bottom: 10px;
    top: auto;
  }

  #panelEdificio {
    width: calc(100% - 20px);
    right: 10px;
    top: 10px;
    max-height: 45vh;
    overflow-y: auto;
  }
}
</style>
</head>

<body>

<div id="panel">
  <h3>¿A dónde quieres ir?</h3>
  <div id="infoRuta">Selecciona un destino</div>
  <ul id="listaDestinos"></ul>
</div>

<div id="panelEdificio" class="oculto"></div>

<div id="map"></div>

<button id="btnNavegar" class="btn-navegar oculto">Iniciar navegación</button>

<script>

// ================= KEYS =================
const apiKey = "Bwc5E9Mj426Ga6cevHzX";
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjllOGM5M2FkZmQ2MjQwZGE5NGE1YmVmMjM3MmZjM2JmIiwiaCI6Im11cm11cjY0In0=";
const ES_MOVIL = window.innerWidth <= 768;
const MEDIA_BASE_URL = "https://davjul.github.io/Uniquindio";

// ================= DESTINOS (COMPLETOS) =================
const destinos = {
  "Bloque Administrativo #1": { lng: -75.6591559, lat: 4.5528674 },
  "Bloque Administrativo #2": { lng: -75.6593123, lat: 4.5528919 },
  "Edificio de Ciencias Básicas y Tecnologías": { lng: -75.6597840, lat: 4.5529046 },
  "Auditorio Bernardo Ramírez Granada": { lng: -75.6600830, lat: 4.5526310 },
  "Instituto Interdisciplinario de las Ciencias": { lng: -75.6597762, lat: 4.5530214 },
  "Edificio de Aulas 50 años": { lng: -75.6600960, lat: 4.5534352 },
  "Vivero Universidad Jardín": { lng: -75.6608072, lat: 4.5534410 },
  "Auditorio Jardín Botánico": { lng: -75.6608063, lat: 4.5533636 },
  "Centro de Entrenamiento en Alturas": { lng: -75.6612422, lat: 4.5532833 },
  "Zona Multicultural": { lng: -75.6615022, lat: 4.5532217 },
  "Laboratorio de Bioterio": { lng: -75.6617237, lat: 4.5529765 },
  "Centro de acopio": { lng: -75.6618036, lat: 4.5528781 },
  "Coliseo": { lng: -75.6587816, lat: 4.5531702 },
  "Bienestar Institucional": { lng: -75.6585798, lat: 4.5536491 },
  "Biblioteca CRAI": { lng: -75.6595813, lat: 4.5564278 }
};

// ================= MAPA =================
const map = new maplibregl.Map({
  container: 'map',
  style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${apiKey}`,
  center: [-75.6605, 4.5530],
  zoom: 16,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new maplibregl.NavigationControl());

let marcadorUsuario = null;
let modoNavegacion = false;
let watchId = null;
let ultimaPosicionSuavizada = null;
const FACTOR_SUAVIZADO = 0.15;

// ================= LOAD =================
map.on("load", () => {
  ubicarUsuario();

  const lista = document.getElementById("listaDestinos");
  Object.keys(destinos).forEach(nombre => {
    const li = document.createElement("li");
    li.textContent = nombre;
    li.onclick = () => seleccionarDestino(nombre);
    lista.appendChild(li);
  });
});

// ================= FUNCIONES =================
function suavizarPosicion(nueva, anterior) {
  if (!anterior) return nueva;
  return [
    anterior[0] + (nueva[0] - anterior[0]) * FACTOR_SUAVIZADO,
    anterior[1] + (nueva[1] - anterior[1]) * FACTOR_SUAVIZADO
  ];
}

function seleccionarDestino(nombre) {
  document.getElementById("btnNavegar").classList.remove("oculto");
}

function ubicarUsuario() {
  navigator.geolocation.getCurrentPosition(pos => {
    const el = document.createElement("div");
    el.className = "marker-usuario";
    marcadorUsuario = new maplibregl.Marker(el)
      .setLngLat([pos.coords.longitude, pos.coords.latitude])
      .addTo(map);
  });
}

function actualizarPosicion(pos) {
  if (!modoNavegacion) return;

  const nuevaCruda = [pos.coords.longitude, pos.coords.latitude];
  const nueva = suavizarPosicion(nuevaCruda, ultimaPosicionSuavizada);
  ultimaPosicionSuavizada = nueva;

  marcadorUsuario.setLngLat(nueva);

  map.easeTo({
    center: nueva,
    zoom: 19.5,
    pitch: 80,
    bearing: pos.coords.heading || map.getBearing(),
    duration: 700
  });
}

function activarModoNavegacion() {
  modoNavegacion = true;
  document.getElementById("btnNavegar").classList.add("oculto");

  map.dragPan.disable();
  map.scrollZoom.disable();
  map.doubleClickZoom.disable();
  map.dragRotate.disable();

  watchId = navigator.geolocation.watchPosition(
    actualizarPosicion,
    e => console.error(e),
    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
  );
}

// ================= BOTÓN =================
document.getElementById("btnNavegar").onclick = activarModoNavegacion;

</script>
</body>
</html>
