<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa Universidad del Quind铆o</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
body { margin:0; font-family: sans-serif; }
#map { width:100vw; height:100vh; }

/* ===== Panel destinos ===== */
#panel {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255,255,255,0.95);
  padding: 12px 15px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  z-index: 10;
  width: 230px;
}

#panel h3 { margin: 0 0 6px 0; font-size: 14px; }
#infoRuta { font-size: 12px; margin-bottom: 8px; }

#panel ul { list-style: none; padding: 0; margin: 0; }

#panel li {
  padding: 6px 10px;
  margin: 4px 0;
  background: #0055ff;
  color: white;
  border-radius: 5px;
  cursor: pointer;
  font-size: 13px;
}

#panel li:hover { background: #003bb3; }

/* ===== Panel edificio ===== */
#panelEdificio {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 320px;
  background: rgba(255,255,255,0.96);
  padding: 14px;
  border-radius: 12px;
  box-shadow: 0 5px 18px rgba(0,0,0,0.25);
  z-index: 10;
}
/* ===== Bot贸n navegaci贸n m贸vil ===== */
.btn-navegar {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #0066ff;
  color: white;
  border: none;
  padding: 12px 18px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 20;
}
.btn-iniciar {
  bottom: 80px;
}

.imagen-edificio {
  width: 100%;
  border-radius: 8px;
  margin-bottom: 8px;
}

.codigo-zona {
  display: inline-block;
  padding: 4px 8px;
  font-size: 11px;
  font-weight: bold;
  border-radius: 6px;
  color: white;
  margin-bottom: 6px;
}

.zona-guayacan { background: #f1e66c; }
.zona-guaduales { background: #8ab844; }
.zona-cambulos { background: #e49645; }
.zona-gualanday { background: #625595; }
.zona-platanillas { background: #b54d55; }
.zona-guamos { background: #90bccb; }

.nivel {
  margin-top: 8px;
  padding: 8px;
  background: #f2f2f2;
  border-radius: 6px;
  font-size: 12px;
}

/* ===== Galer铆a de im谩genes por nivel ===== */
.galeria {
  display: flex;
  gap: 6px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.galeria img {
  width: 128px;
  height: 96px;
  object-fit: cover;
  border-radius: 4px;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.galeria img:hover {
  transform: scale(1.05);
}



.marker-usuario {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: red;
  box-shadow: 0 0 10px rgba(255,0,0,0.8);
  border: 2px solid white;
}

.oculto {
  display: none;
}

/* ===== MVIL ===== */
@media (max-width: 768px) {
  #panel {
    width: calc(100% - 20px);
    left: 10px;
    bottom: 10px;
    top: auto;
  }

  #panel ul {
    display: flex;
    overflow-x: auto;
    gap: 6px;
  }

  #panelEdificio {
    width: calc(100% - 20px);
    right: 10px;
    top: 10px;
    max-height: 45vh;
    overflow-y: auto;
  }

  .imagen-edificio {
    max-height: 120px;
    object-fit: cover;
  }
}
</style>
</head>
<body>


<!-- Panel destinos -->
<div id="panel">
  <h3>驴A d贸nde quieres ir?</h3>
  <div id="infoRuta">Selecciona un destino</div>
  <ul id="listaDestinos"></ul>
</div>

<!-- Panel edificio -->
<div id="panelEdificio" class="oculto"></div>

<div id="map"></div>

<button id="btnNavegar" class="btn-navegar oculto">
  Iniciar navegaci贸n
</button>





<script>

// ================= KEYS =================
const apiKey = "Bwc5E9Mj426Ga6cevHzX";
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjllOGM5M2FkZmQ2MjQwZGE5NGE1YmVmMjM3MmZjM2JmIiwiaCI6Im11cm11cjY0In0=";
const ES_MOVIL = window.innerWidth <= 768;
// ================= BASE DE IMGENES =================

const MEDIA_BASE_URL = "https://davjul.github.io/Uniquindio";
 
// ================= DESTINOS =================
const destinos = {
  "Bloque Administrativo #1": { lng: -75.6591559, lat: 4.5528674 },
  "Bloque Administrativo #2": { lng: -75.6593123, lat: 4.5528919 },

  "Edificio de Ciencias B谩sicas y Tecnolog铆as": { lng: -75.6597840, lat: 4.5529046 },
  "Auditorio Bernardo Ram铆rez Granada": { lng: -75.6600830, lat: 4.5526310 },
 
  "Instituto Interdisciplinario de las Ciencias": { lng: -75.6597762, lat: 4.5530214 },
  "Edificio de Aulas 50 a帽os": { lng: -75.6600960, lat: 4.5534352 },
  "Vivero Universidad Jard铆n": { lng: -75.6608072, lat: 4.5534410 },
  "Auditorio Jard铆n Bot谩nico": { lng: -75.6608063, lat: 4.5533636 },  
  "Centro de Entrenamiento en Alturas": { lng: -75.6612422, lat: 4.5532833 },
  "Zona Intercultural": { lng: -75.6613910, lat: 4.5531892 },  
  "Laboratorio de Bioterio": { lng: -75.6617237, lat: 4.5529765 },
  "Centro de acopio": { lng: -75.6618036, lat: 4.5528781 },

  "Coliseo": { lng: -75.6587816, lat: 4.5531702 },
  "Bienestar Institucional": { lng: -75.6585798, lat: 4.5536491 },
  "Cafeter铆as": { lng: -75.6600505, lat: 4.5549538 },
  "Canchas M煤ltiples": { lng: -75.6590958, lat: 4.5542102 },
  "Piscina": { lng: -75.6588847, lat: 4.5543457 },
  "Camerinos": { lng: -75.6589382, lat: 4.5544453 },
  "Cancha de f煤tbol y pista atl茅tica": { lng: -75.6592456, lat: 4.5541444 },
  "Grader铆as": { lng: -75.6589545, lat: 4.5546772 },
  "Media Torta - Teatro al aire libre": { lng: -75.6590750, lat: 4.5555646 },
  "Centro de Salud": { lng: -75.6587919, lat: 4.5556343 },

  "Edificio Facultad de Educaci贸n": { lng: -75.6609937, lat: 4.5552083 },
  "Edificio Facultad de Econ贸micas": { lng: -75.6614602, lat: 4.5549764 },
  "Facultad de Agroindustria": { lng: -75.6616901, lat: 4.5547966 },

  "Ciencias de la Salud": { lng: -75.6587961, lat: 4.5562350 },
  "Biblioteca CRAI": { lng: -75.6595813, lat: 4.5564278 },
  "Facultad de Ingenier铆a": { lng: -75.6600693, lat: 4.5559045 }

};

// ================= EDIFICIOS =================
const edificios = {
   "Bloque Administrativo #1": {
    codigo: "A1-GUAYACN",
    zonaClase: "zona-guayacan",
    imagenGeneral: "Img/bloque1ext.JPG",
    descripcion: "Edificio administrativo central de la Universidad del Quind铆o.",
    niveles: {
      "Nivel 1":{
        descripcion: "Vicerrector铆a Acad茅mica - dependencia universitaria encargada de coordinar, planificar y gestionar los procesos de docencia, formaci贸n y aseguramiento de la calidad acad茅mica. Orienta sus acciones al servicio de estudiantes y acad茅micos, gestionando el curr铆culo.",
        fotos: [
      "Img/bloque2ext.JPG",
      "Img/bloque10ext.jpg"
        ]
      },
    "Nivel 2":{
      descripcion: "Vicerrector铆a Administrativa - dependencia universitaria encargada de planear, dirigir y controlar los recursos f铆sicos, financieros y humanos de la instituci贸n, asesorando a la Rector铆a",
      fotos: [
      "Img/bloque7ext.jpg"
        ]
      }
    }, 
},

"Bloque Administrativo #2": {
    codigo: "A1-GUAYACN",
    zonaClase: "zona-guayacan",
    descripcion: "Edificio administrativo central de la Universidad del Quind铆o.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    }, 

"Edificio de Ciencias B谩sicas y Tecnolog铆as": {
    codigo: "B1-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion:  "Este edificio se construy贸 tras el terremoto de 1999 como parte de la reconstrucci贸n y expansi贸n del campus, dando origen en el a帽o 2001 al bloque de las facultades de Ciencias B谩sicas y Tecnolog铆as y de Ciencias Humanas y Bellas Artes (incluido el Auditorio Bernardo Ram铆rez Granada), y el Centro de Estudios y Pr谩cticas Pedag贸gicas y Sociales, Cepas",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
"Auditorio Bernardo Ram铆rez Granada": {
    codigo: "B2-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "Auditorio Ubicado en el bloque de Ciencias B谩sicas. Nombrado as铆 en honor a su primer rector, licenciado en pedagog铆a, doctor en ciencias pol铆ticas y escritor, quien fuera directivo en los a帽os 1961 y 1964 ",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "CEPAS": {
    codigo: "B4-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "Auditorio Ubicado en el bloque de Ciencias B谩sicas. Nombrado as铆 en honor a su primer rector, licenciado en pedagog铆a, doctor en ciencias pol铆ticas y escritor, quien fuera directivo en los a帽os 1961 y 1964 ",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Instituto Interdisciplinario de las Ciencias": {
    codigo: "B5-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "El Instituto Interdisciplinario de las Ciencias (IIC) es una unidad acad茅mica y cient铆fica la cual realiza investigaci贸n b谩sica y aplicada en el campo de nuevos materiales para el desarrollo de dispositivos en optoelectr贸nica y en el campo de materiales org谩nicos como el caf茅 y la guadua Angustifolia Kunth.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Edificio de Aulas 50 a帽os": {
    codigo: "B6-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "Construido para conmemorar el medio siglo de la instituci贸n, inaugurado alrededor de 2013-2014 en Armenia, es un moderno complejo de aulas de 2.000 \(m^{2}\).",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Vivero Universidad Jard铆n": {
    codigo: "B8-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "El Vivero de la Universidad del Quind铆o es un centro de producci贸n y conservaci贸n de material vegetal, certificado por el ICA, dedicado a la propagaci贸n de especies nativas, forestales y ornamentales para la restauraci贸n ecol贸gica del departamento.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Auditorio Jard铆n Bot谩nico": {
    codigo: "B9-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "espacio acad茅mico y cultural inaugurado alrededor de 2014, destacado por su arquitectura t铆pica quindiana, entorno natural y colorida infraestructura, dise帽ado para el encuentro, la docencia, eventos de la comunidad universitaria y socializaci贸n de proyectos.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Centro de Entrenamiento en Alturas": {
    codigo: "B10-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "Es una unidad especializada avalada por el Ministerio de Trabajo que forma a trabajadores en seguridad para labores de alto riesgo a m谩s de 1.50 metros de altura. Cuenta con una torre de entrenamiento y ofrece cursos certificados de nivel avanzado, coordinador y entrenador, enfocado en reducir la accidentalidad.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Laboratorio de Bioterio": {
    codigo: "B11-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "es un espacio especializado dise帽ado para la cr铆a, mantenimiento y manejo de animales de laboratorio. Estas instalaciones garantizan condiciones controladas (gen茅ticas y sanitarias) para apoyar investigaciones cient铆ficas, ensayos biol贸gicos y actividades de docencia, asegurando el bienestar animal.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Zona Intercultural": {
    codigo: "Zona: B13-GUADUALES",
    zonaClase: "zona-guaduales",
    imagenGeneral: "Img/InterculturalExt1.jpg",
    descripcion: " inaugurado en 2025, dise帽ado para la integraci贸n, descanso y sano esparcimiento. Sirve como punto de encuentro para actividades art铆sticas, culturales y de salud mental, buscando humanizar la vida universitaria y ofrecer alternativas al consumo de sustancias bajo la supervisi贸n de Bienestar Institucional.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
    
  "Centro de acopio": {
    codigo: "B12-GUADUALES",
    zonaClase: "zona-guaduales",
    descripcion: "se enfoca en la gesti贸n integral, separaci贸n, almacenamiento y valorizaci贸n de residuos aprovechables, impulsando la sostenibilidad, la econom铆a circular y la responsabilidad ambiental en el campus y el departamento.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Bienestar Institucional": {
    codigo: "C2-CMBULOS",
    zonaClase: "zona-cambulos",
    imagenGeneral: "Img/BienestarExt1.jpg",
    descripcion: "Dependencia transversal que promueve la formaci贸n integral, la calidad de vida y la permanencia de estudiantes, docentes y administrativos.",
    niveles:{
      "Nivel 1":{
      descripcion: "Atenci贸n al ciudadano y recepci贸n",
        fotos: ["img/rectoria/nivel1_01.jpg",
      "img/rectoria/nivel1_02.jpg"
        ]
      }
     }
    },
  "Biblioteca CRAI": {
    codigo: "E2-PLATANILLAS",
    zonaClase: "zona-platanillas",
    descripcion: "Centro de Recursos para el Aprendizaje y la Investigaci贸n.",
    niveles: {
      "Nivel 1": "Pr茅stamos y salas generales",
      "Nivel 2": "Salas de estudio y bases de datos",
      "Nivel 3": "Hemeroteca y salas silenciosas"
    }
  }
};

// ================= MAPA =================
const map = new maplibregl.Map({
  container: 'map',
  style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${apiKey}`,
  center: [-75.6605, 4.5530],
  zoom: 16,
  pitch: 60,
  bearing: -20,
  antialias: true
});
map.dragRotate.enable();
map.touchZoomRotate.enableRotation();
map.addControl(new maplibregl.NavigationControl());

let marcadorUsuario = null;
let modoNavegacion = false;
let watchId = null;
let edificiosVisitados = new Set();
let destinoActivo = null;
let rutaCompleta = null;
let rutaRecorridaCoords = [];
let ultimaPosicionSuavizada = null;
const FACTOR_SUAVIZADO = 0.15; // entre 0.1 y 0.3
let bearingSuavizado = null;
const FACTOR_BEARING = 0.08; // m谩s bajo = m谩s estable
let rotacionActiva = false;





// ================= LOAD =================
map.on("load", () => {
  ubicarUsuario();

  map.addLayer({
    id: "3d-buildings",
    source: "maptiler_planet",
    "source-layer": "building",
    type: "fill-extrusion",
    minzoom: 15,
    paint: {
  "fill-extrusion-color": "#d1d1d1",
  "fill-extrusion-height": ["get", "height"],
  "fill-extrusion-base": ["get", "min_height"],
  "fill-extrusion-opacity": 0.85
   }
  });

  const lista = document.getElementById("listaDestinos");
  Object.keys(destinos).forEach(nombre => {
    const li = document.createElement("li");
    li.textContent = nombre;
    li.onclick = () => seleccionarDestino(nombre);
    lista.appendChild(li);
  });
});

// ================= FUNCIONES =================

function suavizarPosicion(nueva, anterior) {
  if (!anterior) return nueva;

  return [
    anterior[0] + (nueva[0] - anterior[0]) * FACTOR_SUAVIZADO,
    anterior[1] + (nueva[1] - anterior[1]) * FACTOR_SUAVIZADO
  ];
}


function seleccionarDestino(nombre) {
  if (!marcadorUsuario) return;

  destinoActivo = nombre;

  const origen = marcadorUsuario.getLngLat();

  calcularRuta(
    { lng: origen.lng, lat: origen.lat },
    destinos[nombre]
  );

  mostrarEdificio(nombre);

  //  RESETEAR navegaci贸n
  modoNavegacion = false;

  const btn = document.getElementById("btnNavegar");
  btn.classList.remove("oculto");
}


function mostrarEdificio(nombre) {
  const panel = document.getElementById("panelEdificio");
  const edificio = edificios[nombre];

  if (!edificio) {
    panel.classList.add("oculto");
    return;
  }

  // CONTENIDO BASE DEL PANEL
  let html = `
    <div class="codigo-zona ${edificio.zonaClase}">
      ${edificio.codigo}
    </div>
    <h4>${nombre}</h4>
    <p>${edificio.descripcion}</p>
  `;

  // IMAGEN GENERAL 
  if (edificio.imagenGeneral) {
    html = `
      <img class="imagen-edificio" src="${edificio.imagenGeneral}">
    ` + html;
  }

  // NIVELES DEL EDIFICIO
  Object.keys(edificio.niveles).forEach(nivel => {
  const info = edificio.niveles[nivel];

  html += `
    <div class="nivel">
      <strong>${nivel}</strong><br>
      ${info.descripcion || ""}
  `;

  if (info.fotos && info.fotos.length) {
    html += `<div class="galeria">`;

    info.fotos.forEach(foto => {
      html += `
        <img src="${MEDIA_BASE_URL}/${foto}" alt="${nivel}">
      `;
    });
    

    html += `</div>`;
  }

  html += `</div>`;
});



  //PINTAR PANEL
  panel.innerHTML = html;
  panel.classList.remove("oculto");
}


function distanciaMetros(lat1, lon1, lat2, lon2) {
  const R = 6371000; // radio tierra
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function recortarRutaDesdePosicion(posicionActual) {
  if (!rutaCompleta || rutaCompleta.length === 0) return;

  let indiceMasCercano = 0;
  let menorDistancia = Infinity;

  rutaCompleta.forEach((coord, index) => {
    const dist = distanciaMetros(
      posicionActual[1],
      posicionActual[0],
      coord[1],
      coord[0]
    );

    if (dist < menorDistancia && dist < 15) {
      menorDistancia = dist;
      indiceMasCercano = index;
    }
  });

  // Nueva ruta = lo que falta
  const rutaRestante = rutaCompleta.slice(indiceMasCercano);

  const src = map.getSource("ruta");
  if (src) {
    src.setData({
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: rutaRestante
      }
    });
  }
}


function mostrarPopupEdificio(nombre) {
  const edificio = edificios[nombre];
  if (!edificio) return;

  new maplibregl.Popup({ closeAfterTimeout: 5000 })
    .setLngLat(destinos[nombre])
    .setHTML(`
      <strong>${nombre}</strong><br>
      <small>${edificio.codigo}</small><br>
      <p style="margin:4px 0;font-size:12px;">
        ${edificio.descripcion}
      </p>
    `)
    .addTo(map);
}


function ubicarUsuario() {
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    const el = document.createElement("div");
    el.className = "marker-usuario";

    marcadorUsuario = new maplibregl.Marker(el)
      .setLngLat([longitude, latitude])
      .addTo(map);
  });
}

function verificarLlegada(lat, lng) {
  if (!destinoActivo) return false;

  const destino = destinos[destinoActivo];
   const distancia = distanciaMetros(
    lat,
    lng,
    destino.lat,
    destino.lng
  );

  return distancia < 10; 
}

function actualizarPosicion(pos) {
  if (!modoNavegacion || !marcadorUsuario) return;

  const { latitude, longitude, heading } = pos.coords;
  const posicionCruda = [longitude, latitude];
const nuevaPos = suavizarPosicion(posicionCruda, ultimaPosicionSuavizada);
ultimaPosicionSuavizada = nuevaPos;


  // Mover marcador
  marcadorUsuario.setLngLat(nuevaPos);

  // Orientaci贸n
  let nuevoBearing = map.getBearing();

if (typeof heading === "number" && heading >= 0 && heading <= 360) {
  if (bearingSuavizado === null) {
    bearingSuavizado = heading;
  } else {
    bearingSuavizado =
      bearingSuavizado + (heading - bearingSuavizado) * FACTOR_BEARING;
  }
  nuevoBearing = bearingSuavizado;
}
// SIEMPRE recortar ruta
recortarRutaDesdePosicion(nuevaPos);


  // C谩mara
  map.easeTo({
    center: nuevaPos,
    bearing: nuevoBearing,
    zoom: ES_MOVIL ? 19.5 : 18.8,
    pitch: ES_MOVIL ? 80 : 70,
    duration: 700
  });

  // ===== RUTA RECORRIDA =====
  rutaRecorridaCoords.push(nuevaPos);

  const src = map.getSource("ruta-recorrida");
  if (src) {
    src.setData({
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: rutaRecorridaCoords
      }
    });
  }

  // ===== POPUPS POR PROXIMIDAD =====
  Object.keys(destinos).forEach(nombre => {
    if (edificiosVisitados.has(nombre)) return;

    const destino = destinos[nombre];
    const edificio = edificios[nombre];
    if (!edificio) return;

    const distancia = distanciaMetros(
      latitude,
      longitude,
      destino.lat,
      destino.lng
    );

    if (distancia < 20) {
      edificiosVisitados.add(nombre);
      mostrarPopupEdificio(nombre);
    }
  });
}

function permitirRotacionMapa() {
  map.dragRotate.enable();
  map.touchZoomRotate.enableRotation();
}



//------MODO NAVEGACIN--------//
function activarModoNavegacion() {
  if (modoNavegacion) return;

  modoNavegacion = true;
  bearingSuavizado = null;
ultimaPosicionSuavizada = null;

  // Ocultar panel en m贸vil
  if (ES_MOVIL) {
    document.getElementById("panel").style.display = "none";
  }

  //  Bloquear interacci贸n manual
  map.dragPan.disable();
  map.dragRotate.disable();
  map.scrollZoom.disable();
  map.doubleClickZoom.disable();
  map.touchZoomRotate.disable();

  //  C谩mara inmersiva inicial
  map.easeTo({
    zoom: 19.5,
    pitch: 80,
    bearing: map.getBearing(),
    duration: 1200
  });

  //  GPS continuo
  watchId = navigator.geolocation.watchPosition(
    actualizarPosicion,
    err => console.error("GPS error", err),
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    }
  );
}

function desactivarModoNavegacion() {
  modoNavegacion = false;

  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  //  Restaurar controles
  map.dragPan.enable();
  map.dragRotate.enable();
  map.scrollZoom.enable();
  map.doubleClickZoom.enable();
  map.touchZoomRotate.enable();

  //  Volver a vista normal
  map.easeTo({
    pitch: 60,
    zoom: 16,
    bearing: 0,
    duration: 800
  });

  document.getElementById("panel").style.display = "";
  document.getElementById("btnNavegar").classList.remove("oculto");
}



// ================= RUTA =================
async function calcularRuta(origen, destino) {
  const url = `https://api.openrouteservice.org/v2/directions/foot-walking?api_key=${ORS_API_KEY}&start=${origen.lng},${origen.lat}&end=${destino.lng},${destino.lat}&format=geojson`;

  const response = await fetch(url);
  const data = await response.json();
  if (!data.features || !data.features.length) return;
  rutaCompleta = data.features[0].geometry.coordinates;
rutaRecorridaCoords = [];

  

  const resumen = data.features[0].properties.summary;
  document.getElementById("infoRuta").innerHTML = `
    <strong>Ruta activa</strong><br>
     ${(resumen.distance/1000).toFixed(2)} km<br>
    憋 ${Math.round(resumen.duration/60)} min
  `;

  if (map.getLayer("ruta")) map.removeLayer("ruta");
  if (map.getSource("ruta")) map.removeSource("ruta");

  map.addSource("ruta", { type: "geojson", data });
  map.addLayer({
    id: "ruta",
    type: "line",
    source: "ruta",
    paint: { "line-color": "#0066ff", "line-width": 6 }
  });
  if (!map.getSource("ruta-recorrida")) {
  map.addSource("ruta-recorrida", {
    type: "geojson",
    data: {
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: []
      }
    }
  });

  map.addLayer({
    id: "ruta-recorrida",
    type: "line",
    source: "ruta-recorrida",
    paint: {
      "line-color": "#ff0000",
      "line-width": 6,
      "line-opacity": 0
    }
  });
}


  const bounds = new maplibregl.LngLatBounds();
  data.features[0].geometry.coordinates.forEach(c => bounds.extend(c));
  map.fitBounds(bounds, { padding: 50, pitch: 60 });
}
// ================= BOTN INICIAR NAVEGACIN =================
const btnNavegar = document.getElementById("btnNavegar");

if (btnNavegar) {
  btnNavegar.onclick = () => {
    activarModoNavegacion();
    btnNavegar.classList.add("oculto");
  };
}


</script>
</body>
</html>

